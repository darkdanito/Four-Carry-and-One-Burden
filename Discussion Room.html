<!--	
		http://luke.breuer.com/tutorial/javascript-drag-and-drop-tutorial.aspx
        Refer to the reference above for the functionaility of the drag and drop below.
        
        https://gist.github.com/karbassi/639453
        Refer to the reference above for the functionaility of Single and Double Click.
-->
<!DOCTYPE HTML>

<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta http-equiv="edit-Type" edit="text/html; charset=utf-8" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.28/angular.min.js"></script>
    	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.28//angular-route.min.js"></script>
    	<script type="text/javascript" src="js/bootstrap.js"></script>
        
        <script src="https://cdn.firebase.com/js/client/2.2.7/firebase.js"></script>
        
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-theme.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/css.css">
        <script type="text/javascript" src="js/DiscussionRoomScript.js"></script>
        
        <title>POSIT</title>
	</head>
	
    <body ng-app="mainModule" ng-controller="mainController">

		<!--	Modal for double click of POSIT Code Block	--> 
        <div class="modal fade" id="expandedPOSIT" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                    
                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:90%">
                                	Yuuki Asuna
                                </td>
                 
								<td rowspan="2">
                                	<button class="btn" data-dismiss="modal" data-toggle="modal" href="#settingPOSIT">Menu</button>
                                </td>
                            </tr>
                            
                            <tr>
                            	<td><p id="necrodiver">Double Click of POSIT Placeholder</p></td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>    

		<!--	Modal for Setting of POSIT Code Block	--> 
        <div class="modal fade" id="settingPOSIT" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">                    
                    <div class="modal-body">

                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:90%">Yuuki Asuna</td>
                                <td>
                                    <button class="btn" data-dismiss="modal" data-toggle="modal" href="#editColorPOSIT">Set Color</button>
                                </td>
                            </tr>
                            
                            <tr>
                            	<td style="width:70%" rowspan="2"><p id="necrodiver2">Settings of POSIT Placeholder</p></td>
                                <td>
                                	<button class="btn" data-dismiss="modal" data-toggle="modal" href="#editPOSIT">Edit</button>
                                </td>
                            </tr>
                            
                            <tr>
                                <td>
                                    <button class="btn" data-dismiss="modal" data-toggle="modal" href="#deletePOSIT">Delete</button>
                                </td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>    

		<!--	Modal for Delete POSIT Code Block	--> 
        <div class="modal fade" id="deletePOSIT" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">                
                    <div class="modal-body">

                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:70%" colspan="2">Are you sure you want to delete this post from discussion ?</td>
                            </tr>
                            
                            <tr>
                            	<td><button class="btn" data-dismiss="modal" onclick="onDelete()">Delete</button></td>
                                <td><button class="btn" data-dismiss="modal">Cancel</button></td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>        

		<!--	Modal for Edit Post of POSIT Code Block	--> 
        <div class="modal fade" id="editPOSIT" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">

                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:70%" colspan="3">Yuuki Asuna</td>
                                
                            </tr>
                            
                            <tr>
                            	<td colspan="2">
                                	<textarea rows="10" cols="57" name="textbox2" id="editPostContent" type="text">
                                    	Please input your ideas here
                                     	</textarea>
                                </td>
                            </tr>
                            
                            <tr>
                            	<td><button class="btn" data-dismiss="modal" onclick="onUpdate()">Update</button></td>
                                <td><button class="btn" data-dismiss="modal">Cancel</button></td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>       

		<!--	Modal for Edit Color of POSIT Code Block	-->    
        <div class="modal fade" id="editColorPOSIT" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">

                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:70%" colspan="5">Yuuki Asuna</td>
                            </tr>
                            
                            <tr>
                            	<td colspan="5">
  									<p id="editColorContent">Change POSIT Color Placeholder</p>
                                </td>
                            </tr>
                            
                            <tr>
                            	
                               	<td>
									<input name="buttonExecute" onclick="onUpdateColor('thick solid black')" data-dismiss="modal" type="button" value="Normal" class="btn btn-lg btn-white"/>
                                </td>
                                
                                <td>
                                    <input name="buttonExecute" onclick="onUpdateColor('thick solid red')" data-dismiss="modal" type="button" value="Red" class="btn btn-lg btn-danger"/>
                                </td>
                                
                                <td>
                                    <input name="buttonExecute" onclick="onUpdateColor('thick solid blue')" data-dismiss="modal" type="button" value="Blue" class="btn btn-lg btn-primary"/>
                                </td>
                                
                                <td>
                                	<input name="buttonExecute" onclick="onUpdateColor('thick solid green')" data-dismiss="modal" type="button" value="Green" class="btn btn-lg btn-success"/>
                                </td>
                                
                                <td>
                                	<button class="btn" data-dismiss="modal">Cancel</button>
                                </td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>       

		<!--	Modal for confirmation of Snap an Image Block	--> 
        <div class="modal fade" id="snapAnImage" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
      
                        <table class="table table-bordered" style="width:100%">
                        	<tr>
                            	<td style="width:90%">
                                	Discussion has been downloaded !
                                </td>
                            </tr>
                            
                            <tr>
                            	<td><button class="btn" data-dismiss="modal">Ok</button></td>
                            </tr>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>    
    
		<!--	Main Code Block	-->    
        
        <div id="debug">

			<table class="table table-bordered" style="width:100%">
            	<tr>
                	<td><b>Members Joined: </b></td>
                    <td style='text-align:center;vertical-align:middle'><b>Discussion - Session 1</b></td>
                    <td style="width:10%"><button class="btn" data-toggle="modal" href="#snapAnImage">Snap an Image</button></td>
                    <!--
                    	<button class="btn" onclick="XXXXX()">Snap an Image</button>
                    -->
                </tr>
                
				<tr>
                	<td>{{loggingUserName}}</td>
                    <td rowspan="3" colspan="2" id="canvas" >
					<!--
                            <div id="results">
        					</div>
                    -->
                    </td>
                </tr>
                
				<tr>
                	<td style="width:25%">
                    	<textarea rows="15" cols="33" name="textbox1" id="textbox1" type="text">Please input your ideas here</textarea>
                    </td>
                </tr>
                
				<tr>
                	<td>
                        <input id = "sendMessage" name="buttonExecute" type="button" value="Black" class="btn btn-lg btn-white"/>
					                  
                        <input id = "sendMessage2" name="buttonExecute" type="button" value="Red" class="btn btn-lg btn-danger"/>
                        <input id = "sendMessage3" name="buttonExecute" type="button" value="Blue" class="btn btn-lg btn-primary"/>
                        <input id = "sendMessage4" name="buttonExecute" type="button" value="Green" class="btn btn-lg btn-success"/>
                    <!--
						<input name="buttonExecute" onclick="myFunctionPostIT('thick solid green')" type="button" value="Green" class="btn btn-lg btn-success"/>
                    -->
                    </td>
				</tr>
            </table>
		</div>

<!--
            <div class="drag" style="width:10%">Item 1</div>            
            <div class="drag" style="width:10%">Item 2</div>        
            <button onclick="myFunction()">Click me</button>
			<img class="drag" src="drag_image.png" alt="drag image" />
-->

	<script language="JavaScript" type="text/javascript">
        <!--

		var username;

//		var buttonSetUser = document.getElementById('setUser');
		var buttonSendMessage = document.getElementById('sendMessage');
		var buttonSendMessage2 = document.getElementById('sendMessage2');
		var buttonSendMessage3 = document.getElementById('sendMessage3');
		var buttonSendMessage4 = document.getElementById('sendMessage4');
		
		var textMessage = document.getElementById('textbox1');
		
		var myFirebase = new Firebase("https://c4posit.firebaseIO.com/").child("chat");
		
		var usernameInput = "Yuuki Asuna";
        username = usernameInput;
		
		myFirebase.on('child_added', function(snapshot) 
		{
			var key = snapshot.key();
			var msg = snapshot.val();
			
			var x = getOffset( document.getElementById('canvas') ).top; 
			var y = getOffset( document.getElementById('canvas') ).left; 

			var html = '<div id = "'+key+'" class="drag" style= "width: 20% ; border: '+msg.color+'; left : '+msg.XPos+' ; top : '+msg.YPos+'">' +
//			var html = '<div id = "'+key+'" class="drag" style= "width: 20% ; position: absolute; left : '+x+'px ; top : '+y+'px">' + 
//						'<b>' + msg.author + '</b>' + 
//						'<p>' + msg.message + '</p>' +
//						'<p>' + msg.XPos + '</p>' +
//						'<p>' + msg.YPos + '</p>' + 
						msg.message 
						'</div>';
			document.querySelector("#canvas").innerHTML += html;
		});
		
		
		myFirebase.on('child_changed', function(snapshot) 
		{
			var key = snapshot.key();
			var msg = snapshot.val();
			var html = msg.message;
			var chatComponent = document.querySelector("#"+key);
			
			chatComponent.className = "drag";
			chatComponent.innerHTML = html;
			
			chatComponent.style.left = msg.XPos;
			chatComponent.style.top = msg.YPos;
			chatComponent.style.border = msg.color;
		});
		
		myFirebase.on('child_removed', function(snapshot) 
		{
			var key = snapshot.key();
			var msg = snapshot.val();
			var html = "Message has been deleted";
			
			document.querySelector("#"+key).innerHTML = html;
			document.querySelector("#"+key).remove();
		});
		
		
		buttonSendMessage.addEventListener("click", function() 
		{
			var message = textMessage.value;
		
			username = username.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			message = message.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			
			var dbXPos = getOffset( document.getElementById('canvas') ).top; 
			var dbYPos = getOffset( document.getElementById('canvas') ).left; 
			
			var color = "thick solid black";
			
			myFirebase.push({author:username, message:message, color : color, XPos: dbXPos, YPos:dbYPos });
			textMessage.value = "Please input your ideas here";
		});
		
		buttonSendMessage2.addEventListener("click", function() 
		{
			var message = textMessage.value;
		
			username = username.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			message = message.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			
			var dbXPos = getOffset( document.getElementById('canvas') ).top; 
			var dbYPos = getOffset( document.getElementById('canvas') ).left; 
			
			var color = "thick solid red";
			
			myFirebase.push({author:username, message:message, color : color, XPos: dbXPos, YPos:dbYPos });
			textMessage.value = "Please input your ideas here";
		});
		
		buttonSendMessage3.addEventListener("click", function() 
		{
			var message = textMessage.value;
		
			username = username.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			message = message.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			
			var dbXPos = getOffset( document.getElementById('canvas') ).top; 
			var dbYPos = getOffset( document.getElementById('canvas') ).left; 
			
			var color = "thick solid blue";
			
			myFirebase.push({author:username, message:message, color : color, XPos: dbXPos, YPos:dbYPos });
			textMessage.value = "Please input your ideas here";
		});
		
		buttonSendMessage4.addEventListener("click", function() 
		{
			var message = textMessage.value;
		
			username = username.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			message = message.replace(/\</g, "&lt;").replace(/\>/g, "&gt;");
			
			var dbXPos = getOffset( document.getElementById('canvas') ).top; 
			var dbYPos = getOffset( document.getElementById('canvas') ).left; 
			
			var color = "thick solid green";
			
			myFirebase.push({author:username, message:message, color : color, XPos: dbXPos, YPos:dbYPos });
			textMessage.value = "Please input your ideas here";
		});
//////////////////////////////////////////////////////////////////////////////
//////////////////				Mouse Click Codes 		 	//////////////////
//////////////////////////////////////////////////////////////////////////////				
		function $(id)
        {
            return document.getElementById(id);
        }
        
        var _startX = 0;					// mouse starting positions
        var _startY = 0;
        var _offsetX = 0;					// current element offset
        var _offsetY = 0;
        var _dragElement;					// needs to be passed from OnMouseDown to OnMouseMove
        var _oldZIndex = 0;					// we temporarily increase the z-index during drag
        var _debug = $('debug');			// makes life easier
		var divName;
		
        InitDragDrop();
        
        function InitDragDrop()
        {
            document.onmousedown = OnMouseDown;
            document.onmouseup = OnMouseUp;
        }
        
        function OnMouseDown(e)
        {
            // IE is retarded and doesn't pass the event object
            if (e == null) 
                e = window.event; 
            
            // IE uses srcElement, others use target
            var target = e.target != null ? e.target : e.srcElement;
        
            // for IE, left click == 1
            // for Firefox, left click == 0
            if ((e.button == 1 && window.event != null || 
                e.button == 0) && 
                target.className == 'drag')
            {
                // grab the mouse position
                _startX = e.clientX;
                _startY = e.clientY;
                
                // grab the clicked element's position
                _offsetX = ExtractNumber(target.style.left);
                _offsetY = ExtractNumber(target.style.top);
                
                // bring the clicked element to the front while it is being dragged
                _oldZIndex = target.style.zIndex;
                target.style.zIndex = 10000;
                
                // we need to access the element in OnMouseMove
                _dragElement = target;
        
                // tell our code to start moving the element with the mouse
                document.onmousemove = OnMouseMove;
                
                // cancel out any text selections
                document.body.focus();
                
                // prevent text selection in IE
                document.onselectstart = function () { return false; };
                // prevent IE from trying to drag an image
                target.ondragstart = function() { return false; };
                
                // prevent text selection (except IE)
                return false;
            }
        }
        
        function ExtractNumber(value)
        {
            var n = parseInt(value);
            
            return n == null || isNaN(n) ? 0 : n;
        }
        
        function OnMouseMove(e)
        {
            if (e == null) 
                var e = window.event; 
        
            // this is the actual "drag code"
            _dragElement.style.left = (_offsetX + e.clientX - _startX) + 'px';
            _dragElement.style.top = (_offsetY + e.clientY - _startY) + 'px';
			
			divName = e.target.id;
	
			if (divName != 'canvas' && divName != 'textbox1')
			{
				var getXPos = _dragElement.style.left;
				var getYPos = _dragElement.style.top;
	//          _debug.innerHTML = '(' + _dragElement.style.left + ', ' + _dragElement.style.top + ')';	
	
				myFirebase.child(divName).update({ XPos: getXPos, YPos: getYPos });
			}
        }
        
        function OnMouseUp(e)
        {
            if (_dragElement != null)
            {
                _dragElement.style.zIndex = _oldZIndex;
        
                // we're done with these events until the next OnMouseDown
                document.onmousemove = null;
                document.onselectstart = null;
                _dragElement.ondragstart = null;
        
                // this is how we know we're not dragging
                _dragElement = null;
                
//				_debug.innerHTML = 'mouse up';
            }
        }
		
        //-->
		
//	function myFunctionPostIT(color)
//	{
//		var output = document.getElementById('canvas');
//	
//		var uniqid = Date.now();
//	
//		var ele = document.createElement("div");
//			ele.setAttribute("id",uniqid);
//			ele.setAttribute("class","drag");
//			ele.setAttribute("style","width:20%");
//			ele.style.border = color;
//			ele.innerHTML=document.getElementById('textbox1').value;
//			output.appendChild(ele);
//	}
	
	function $(id)
	{
		return document.getElementById(id);
	}

	var globalDivID = '';
	var clickCount = 0,
	
	mouseMove   = function(e) 
	{
//		console.log('drag click');
		debug.removeEventListener('mousemove', mouseMove);
		clear();
		
		_startX = e.clientX;
		_startY = e.clientY;
		
		// grab the clicked element's position
		_offsetX = ExtractNumber(target.style.left);
		_offsetY = ExtractNumber(target.style.top);
		
		// bring the clicked element to the front while it is being dragged
		_oldZIndex = target.style.zIndex;
		target.style.zIndex = 10000;
		
		// we need to access the element in OnMouseMove
		_dragElement = target;
		
		// tell our code to start moving the element with the mouse
		document.onmousemove = OnMouseMove;
		
		// cancel out any text selections
		document.body.focus();
		
		// prevent text selection in IE
		document.onselectstart = function () { return false; };
		// prevent IE from trying to drag an image
		target.ondragstart = function() { return false; };
		
		// prevent text selection (except IE)
		return false;
	},
	
	clear = function() 
	{
		clickCount = 0;
		clearTimeout(singleClickTimer);
	},
	
	singleClickTimer;
	
	debug.addEventListener('mousedown', function() 
	{
		clickCount++;
		
// 		Single Click
		if(clickCount === 1) 
		{
////		debug.addEventListener('mousemove', mouseMove);
		
			singleClickTimer = setTimeout(function() 
			{
//			console.log('single click');
			clickCount = 0;
			}, 400);
		
// 		Double Click
		} else if (clickCount === 2) 
		{
			var $j = jQuery.noConflict();
			$j(function() 
			{
			  $j('div').on('dblclick', function()
			  {
				var $k = jQuery.noConflict();
					$k('#expandedPOSIT').modal('show');
				});
				
				
				var $l = jQuery.noConflict();
				$l('#debug').on('dblclick', 'div', function(e)
				{					
					document.getElementById("necrodiver").innerHTML = document.getElementById(e.target.id).innerHTML;
					document.getElementById("necrodiver2").innerHTML = document.getElementById(e.target.id).innerHTML;
					document.getElementById("editPostContent").innerHTML = document.getElementById(e.target.id).innerHTML;
					document.getElementById("editColorContent").innerHTML = document.getElementById(e.target.id).innerHTML;
								
					globalDivID = document.getElementById(e.target.id).id;
				});

			});
			
			clear();
		}
	}, false);

	window.addEventListener('mouseup', function() 
	{
////		debug.removeEventListener('mousemove', mouseMove);
	});


	function onDelete()
	{
		console.log("delete omg");
		console.log(globalDivID);
//		var $q = jQuery.noConflict();
//		$q('#' + globalDivID).closest("div").remove();
		myFirebase.child(globalDivID).remove();
	}
	
	function onUpdate()
	{
//		document.getElementById(globalDivID).innerHTML = document.getElementById('editPostContent').value;
		var newMessage = document.getElementById('editPostContent').value;
		myFirebase.child(globalDivID).update({ message: newMessage });
	}
	
	function onUpdateColor(color)
	{
//		var $xx = jQuery.noConflict();	
//		$xx("#" + globalDivID).css("border", color);
		
		var newColor = color;
		myFirebase.child(globalDivID).update({ color: newColor });	
	}
	
	function getOffset(el) 
	{
		var _x = 0;
		var _y = 0;
		
		while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) 
		{
			_x += el.offsetLeft - el.scrollLeft;
			_y += el.offsetTop - el.scrollTop;
			el = el.offsetParent;
		}
		
    	return { top: _y, left: _x };
	}
		
    </script>
    
	<script type="text/javascript" src="js/coreJSandJQuery.js"></script>
    
	</body>
</html>